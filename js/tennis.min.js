const WINNER=1,UNFORCED_ERROR=2,ACE=3,SERVICE_WINNER=4,DOUBLE_FAULT=5,RETURN_WINNER=6,REGULAR=7;class Point{constructor(e,s,t,i){this.winner=e,this.how=s,this.fault=t,this.how===DOUBLE_FAULT&&(this.fault=1),this.server=i}}class Game{constructor(e){this.server=e,this.winner=0,this.score={1:0,2:0},this.iscore={1:0,2:0},this.points=[]}name_of_score(e){return{0:0,1:15,2:30,3:40}[e]}score_point(e,s,t){if(this.winner)return 0;let i=new Point(e,s=s||REGULAR,t);return this.iscore[e]++,this.points.push(i),this.update_game(),1}remove_point(){if(0===this.points.length)return;let e=this.points.pop();this.iscore[e.winner]--,this.update_game()}update_game(){let e=1,s=2;this.winner=0,this.iscore[2]>this.iscore[1]&&(e=2,s=1),this.iscore[e]>=4?(this.score[e]="-",this.score[s]="-",this.iscore[e]-this.iscore[s]>1?this.winner=e:this.iscore[e]==this.iscore[s]?(this.score[e]="DEUCE",this.score[s]="DEUCE"):this.score[e]="ADV"):(this.score[e]=this.name_of_score(this.iscore[e]),this.score[s]=this.name_of_score(this.iscore[s]))}}class TieBreak{constructor(e){this.server=e,this.winner=0,this.score={1:0,2:0},this.points=[]}score_point(e,s,t){if(this.winner)return 0;let i=new Point(e,s=s||REGULAR,t,this.server);return this.score[e]++,this.points.push(i),this.update_game(),1}remove_point(){if(0===this.points.length)return;let e=this.points.pop();this.score[e.winner]--,this.update_game()}update_game(){let e=1,s=2;this.winner=0,(this.score[1]+this.score[2])%2!=0&&(this.server=1===this.server?2:1),this.score[2]>this.score[1]&&(e=2,s=1),this.score[e]>=7&&this.score[e]-this.score[s]>=2&&(this.winner=e)}}class Set{constructor(e){this.winner=0,this.score={1:0,2:0},this.game=new Game(e),this.games=[],this.tiebreak=null}score_point(e,s,t){this.tiebreak?this.tiebreak.score_point(e,s,t):this.game.score_point(e,s,t),this.update_set()}remove_point(){if(this.tiebreak&&this.tiebreak.score[1]+this.tiebreak.score[2]>0)return this.tiebreak.remove_point(),this.winner=0,this.update_set(),1;this.tiebreak=null,0==this.game.score[1]&&0==this.game.score[2]&&0!=this.games.length&&(this.game=this.games.pop(),this.score[this.game.winner]--),this.winner=0,this.game.remove_point(),this.update_set()}update_set(){let e,s=this.game.server%2==0?1:2;if(this.tiebreak&&this.tiebreak.winner)e=this.tiebreak.winner;else{if(!this.game.winner)return;e=this.game.winner,this.games.push(this.game),this.game=new Game(s)}this.score[e]++;let t=1,i=2;if(this.score[2]>this.score[1]&&(t=2,i=1),6===this.score[t]&&6===this.score[i])return this.tiebreak=new TieBreak(s),void(this.next_server=1===s?2:1);this.score[t]>=6&&this.score[t]-this.score[i]>=2&&(this.winner=t),7===this.score[t]&&6===this.score[i]&&(this.winner=t),this.next_server=s}}class TennisMatch{constructor(e,s,t){if(t%2==0)return 0;this.player={1:e,2:s},this.num_sets=t,this.score={1:0,2:0},this.set=new Set(1),this.sets=[]}score_point(e,s,t){this.winner||(this.set.score_point(e,s,t),this.update_match())}remove_point(){0==this.set.game.score[1]&&0==this.set.game.score[2]&&0===this.set.games.length&&0!=this.sets.length&&(this.set=this.sets.pop(),this.score[this.set.winner]--),this.winner=0,this.set.remove_point(),this.update_match()}update_match(){if(!this.set.winner)return;this.score[this.set.winner]++;let e=this.set.next_server;this.sets.push(this.set),this.set=new Set(e);let s=this.score[1]>this.score[2]?1:2;this.score[s]>this.num_sets/2&&(this.winner=s)}match_stats(){let e={1:{aces:0,breaks:0,points_served:0,faults:0,double_faults:0,unforced_errors:0,service_winners:0,winners:0,return_winners:0},2:{aces:0,breaks:0,points_served:0,faults:0,double_faults:0,unforced_errors:0,service_winners:0,winners:0,return_winners:0}},s=JSON.parse(JSON.stringify(this)),t=s.sets;t.push(s.set);for(let s=0;s<t.length;s++){let i=t[s].games;i.push(t[s].game),t[s].tiebreak&&i.push(t[s].tiebreak);for(let s=0;s<i.length;s++){let t=i[s];t.iscore&&t.winner&&t.winner!=t.server&&e[t.winner].breaks++;let r=i[s].points;for(let s=0;s<r.length;s++){let i=r[s],h=i.server?i.server:t.server;if(e[h].points_served++,i.fault&&e[h].faults++,i.how===DOUBLE_FAULT&&e[h].double_faults++,i.how===ACE&&e[h].aces++,i.how===SERVICE_WINNER&&e[h].service_winners++,i.how===UNFORCED_ERROR){e[1===i.winner?2:1].unforced_errors++}i.how===WINNER&&e[i.winner].winners++,i.how===RETURN_WINNER&&e[i.winner].return_winners++}}}return e}match_score(e){let s=1;1===e&&(s=2);let t=[];return this.sets.forEach(function(i,r){let h=i.score[e]+"-"+i.score[s];i.tiebreak&&(h=h+" ("+i.tiebreak.score[e]+"-"+i.tiebreak.score[s]+")"),t.push(h)}),this.winner||t.push(this.set.score[e]+"-"+this.set.score[s]),t.join(", ")}match_summary(){let e=this.set.game;this.set.tiebreak&&(e=this.set.tiebreak);let s=1===e.server?2:1,t={meta:{type:"Game",server:e.server,receiver:s,player:{1:this.player[1],2:this.player[2]}},1:{sets:this.score[1],games:this.set.score[1],points:this.set.game.score[1]},2:{sets:this.score[2],games:this.set.score[2],points:this.set.game.score[2]}};return this.set.tiebreak&&(t[1].points=this.set.tiebreak.score[1],t[2].points=this.set.tiebreak.score[2],t.meta.type="Tiebreak"),this.winner?(t.winner=this.winner,t.match_score=this.match_score(this.winner)):t.match_score=this.match_score(e.server),t}}